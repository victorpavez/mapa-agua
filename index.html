<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa de Lotes - Agua</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body, #map {
      height: 100%; margin: 0; padding: 0;
    }
    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 18px;
      z-index: 1000;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      font-family: 'Segoe UI', sans-serif;
      border-radius: 12px;
      width: 280px;
      font-size: 14px;
      line-height: 1.4;
    }
    .controls label {
      display: block;
      margin-top: 10px;
      font-weight: 600;
    }
    .controls select, .controls input[type=checkbox] {
      margin-top: 5px;
      margin-bottom: 10px;
    }
    .counter {
      margin-top: 12px;
      font-size: 14px;
    }
    .counter strong {
      display: block;
      margin-top: 6px;
    }
    .counter .highlight {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
      font-weight: bold;
    }
    .dot {
      width: 14px;
      height: 14px;
      display: inline-block;
      border-radius: 3px;
      border: 1px solid #333;
    }
    .dot.green { background-color: #2ecc71; }
    .dot.red { background-color: #e74c3c; }
    .dot.gray { background-color: #999; }
    .dot.blue { background-color: #3498db; }
    .legend {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: white;
      padding: 12px;
      font-size: 13px;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
      z-index: 999;
      line-height: 1.6;
    }
    .legend div {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .legend-color {
      width: 14px;
      height: 14px;
      border-radius: 2px;
      border: 1px solid #333;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="controls">
    <label>üíß Mostrar agua seg√∫n:</label>
    <select id="distancia" onchange="actualizarMapa()">
      <option value="agua_40m">Distancia 40m</option>
      <option value="agua_10m">Distancia 10m</option>
    </select>

    <label><input type="checkbox" id="mostrarSinID" checked onchange="actualizarMapa()" /> üéöÔ∏è Mostrar lotes sin ID en gris</label>

    <label><input type="checkbox" id="mostrarCapaAgua" onchange="toggleCapaAgua()" checked /> üö∞ Mostrar ca√±er√≠a de agua</label>

    <div class="counter" id="contador"></div>
  </div>

  <div class="legend">
    <strong>Leyenda:</strong>
    <div><div class="legend-color" style="background: green;"></div> Con agua</div>
    <div><div class="legend-color" style="background: red;"></div> Sin agua</div>
    <div><div class="legend-color" style="background: gray;"></div> Sin ID (opcional)</div>
    <div><div class="legend-color" style="background: blue;"></div> Ca√±er√≠a de agua</div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map("map").setView([-37.403, -68.931], 16);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "¬© OpenStreetMap contributors",
      maxZoom: 20,
    }).addTo(map);

    let geojsonOriginal, geojsonLayer, capaAgua;

    fetch("AGUSIONO.geojson")
      .then(res => res.json())
      .then(data => {
        geojsonOriginal = data;
        actualizarMapa();
      })
      .catch(err => {
        alert("‚ùå Error cargando AGUSIONO.geojson");
        console.error(err);
      });

    function actualizarMapa() {
      if (geojsonLayer) geojsonLayer.remove();

      const distancia = document.getElementById("distancia").value;
      const mostrarSinID = document.getElementById("mostrarSinID").checked;
      let total = 0, conAgua = 0, sinAgua = 0, sinID = 0, sinAguaSinID = 0, conAguaSinID = 0;

      geojsonLayer = L.geoJSON(geojsonOriginal, {
        style: feature => {
          const tieneID = feature.properties.id_lote !== null;
          const agua = feature.properties[distancia] === "SI";
          total++;
          if (!tieneID) sinID++;
          if (agua) {
            conAgua++;
            if (!tieneID) conAguaSinID++;
          } else {
            sinAgua++;
            if (!tieneID) sinAguaSinID++;
          }

          const color = !tieneID && mostrarSinID ? "gray" : agua ? "green" : "red";

          return {
            color,
            weight: 1,
            fillOpacity: 0.5
          };
        },
        onEachFeature: (feature, layer) => {
          const p = feature.properties;
          layer.bindPopup(`
            üÜî <b>ID:</b> ${p.id_lote ?? "(sin ID)"}<br>
            üè∑Ô∏è <b>N√∫mero:</b> ${p.numero_lote ?? "-"}<br>
            üèòÔ∏è <b>Manzana:</b> ${p.id_manzana ?? "-"}<br>
            üíß <b>Agua (${distancia}):</b> ${p[distancia] ?? "-"}
          `);
        }
      }).addTo(map);

      const porcentaje = ((conAgua / total) * 100).toFixed(1);
      document.getElementById("contador").innerHTML = `
        <strong>Total lotes:</strong> ${total}
        <strong>Con agua:</strong> ${conAgua} (${porcentaje}%)
        <strong>Sin agua:</strong> ${sinAgua} (${(100 - porcentaje).toFixed(1)}%)
        <strong>Sin ID:</strong> ${sinID}
        <div class="highlight"><span class="dot red"></span> Sin agua y sin ID: ${sinAguaSinID}</div>
        <div class="highlight"><span class="dot green"></span> Con agua y sin ID: ${conAguaSinID}</div>
      `;
    }

    function toggleCapaAgua() {
      const mostrar = document.getElementById("mostrarCapaAgua").checked;
      if (mostrar && !capaAgua) {
        fetch("AGUACA√ëERIA.geojson")
          .then(res => res.json())
          .then(data => {
            capaAgua = L.geoJSON(data, {
              style: {
                color: "blue",
                weight: 2
              }
            }).addTo(map);
          });
      } else if (!mostrar && capaAgua) {
        capaAgua.remove();
        capaAgua = null;
      }
    }
  </script>
</body>
</html>
