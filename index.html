<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa de Lotes - Agua</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body {
      height: 100%; margin: 0; padding: 0;
      font-family: 'Segoe UI', sans-serif;
    }
    #map {
      height: 100%;
      margin-left: 300px;
    }
    .controls {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      width: 280px;
      background: white;
      padding: 18px;
      box-shadow: 2px 0 8px rgba(0,0,0,0.2);
      z-index: 1000;
      overflow-y: auto;
    }
    .controls label {
      font-weight: 600;
      display: block;
      margin-top: 10px;
    }
    .controls input[type="text"],
    .controls select {
      width: 100%;
      padding: 6px;
      margin-top: 5px;
      margin-bottom: 10px;
      box-sizing: border-box;
      font-size: 14px;
    }
    .checkbox-inline {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 10px;
      font-weight: 600;
    }
    .counter {
      margin-top: 16px;
      font-size: 14px;
    }
    .legend {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: white;
      padding: 12px;
      font-size: 13px;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
      z-index: 999;
      line-height: 1.6;
    }
    .legend div {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .legend-color, .dot {
      width: 14px;
      height: 14px;
      border-radius: 2px;
      border: 1px solid #333;
    }
    .dot.green { background-color: #2ecc71; }
    .dot.red { background-color: #e74c3c; }
    .dot.gray { background-color: #999; }
    .dot.blue { background-color: #3498db; }
  </style>
</head>
<body>
  <div class="controls">
    <input type="text" id="busqueda" placeholder="üîç Buscar ID de lote" oninput="buscarLote()" />

    <label>üíß Mostrar agua seg√∫n:</label>
    <select id="distancia" onchange="actualizarMapa()">
      <option value="agua_40m">Distancia 40m</option>
      <option value="agua_10m">Distancia 10m</option>
    </select>

    <div class="checkbox-inline">
      <input type="checkbox" id="mostrarSinID" checked onchange="actualizarMapa()" />
      <label for="mostrarSinID">Mostrar lotes sin ID en gris</label>
    </div>

    <div class="checkbox-inline">
      <input type="checkbox" id="mostrarCapaAgua" onchange="toggleCapaAgua()" checked />
      <label for="mostrarCapaAgua">Mostrar ca√±er√≠a de agua</label>
    </div>

    <div class="counter" id="contador"></div>

    <div class="highlight" style="margin-top: 20px;">
      <span class="dot red"></span> <strong>Sin agua y sin ID:</strong> <span id="sinAguaSinID"></span>
    </div>
    <div class="highlight">
      <span class="dot green"></span> <strong>Con agua y sin ID:</strong> <span id="conAguaSinID"></span>
    </div>
  </div>

  <div id="map"></div>

  <div class="legend">
    <strong>Leyenda:</strong>
    <div><div class="legend-color" style="background: green;"></div> Con agua</div>
    <div><div class="legend-color" style="background: red;"></div> Sin agua</div>
    <div><div class="legend-color" style="background: gray;"></div> Sin ID (opcional)</div>
    <div><div class="legend-color" style="background: blue;"></div> Ca√±er√≠a de agua</div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map("map").setView([-37.403, -68.931], 16);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "¬© OpenStreetMap contributors",
      maxZoom: 20,
    }).addTo(map);

    let geojsonOriginal, geojsonLayer, capaAgua;

    fetch("AGUSIONO.geojson")
      .then(res => res.json())
      .then(data => {
        geojsonOriginal = data;
        actualizarMapa();
      });

    function calcularEstadisticas(distancia, mostrarSinID) {
      let total = 0, conAgua = 0, sinAgua = 0, sinID = 0, sinAguaSinID = 0, conAguaSinID = 0;

      const style = feature => {
        const tieneID = feature.properties.id_lote !== null;
        const agua = feature.properties[distancia] === "SI";
        total++;
        if (!tieneID) sinID++;
        if (agua) {
          conAgua++;
          if (!tieneID) conAguaSinID++;
        } else {
          sinAgua++;
          if (!tieneID) sinAguaSinID++;
        }

        const color = !tieneID && mostrarSinID ? "gray" : agua ? "green" : "red";

        return {
          color,
          weight: 1,
          fillOpacity: 0.5
        };
      };

      return { total, conAgua, sinAgua, sinID, sinAguaSinID, conAguaSinID, style };
    }

    function actualizarMapa() {
      if (geojsonLayer) geojsonLayer.remove();

      const distancia = document.getElementById("distancia").value;
      const mostrarSinID = document.getElementById("mostrarSinID").checked;
      const stats = calcularEstadisticas(distancia, mostrarSinID);

      geojsonLayer = L.geoJSON(geojsonOriginal, {
        style: stats.style,
        onEachFeature: (feature, layer) => {
          const p = feature.properties;
          layer.bindPopup(`
            üÜî <b>ID:</b> ${p.id_lote ?? "(sin ID)"}<br>
            üè∑Ô∏è <b>N√∫mero:</b> ${p.numero_lote ?? "-"}<br>
            üè° <b>Manzana:</b> ${p.id_manzana ?? "-"}<br>
            üíß <b>Agua (${distancia}):</b> ${p[distancia] ?? "-"}
          `);
        }
      }).addTo(map);

      const porcentaje = ((stats.conAgua / stats.total) * 100).toFixed(1);
      document.getElementById("contador").innerHTML = `
        <strong>Total lotes:</strong> ${stats.total}<br>
        <strong>Con agua:</strong> ${stats.conAgua} (${porcentaje}%)<br>
        <strong>Sin agua:</strong> ${stats.sinAgua} (${(100 - porcentaje).toFixed(1)}%)<br>
        <strong>Sin ID:</strong> ${stats.sinID}
      `;
      document.getElementById("sinAguaSinID").textContent = stats.sinAguaSinID;
      document.getElementById("conAguaSinID").textContent = stats.conAguaSinID;
    }

    function toggleCapaAgua() {
      const mostrar = document.getElementById("mostrarCapaAgua").checked;
      if (mostrar && !capaAgua) {
        fetch("AGUACA√ëERIA.geojson")
          .then(res => res.json())
          .then(data => {
            capaAgua = L.geoJSON(data, {
              style: {
                color: "blue",
                weight: 2
              }
            }).addTo(map);
          });
      } else if (!mostrar && capaAgua) {
        capaAgua.remove();
        capaAgua = null;
      }
    }

    function buscarLote() {
      const texto = document.getElementById("busqueda").value.toLowerCase();
      geojsonLayer.eachLayer(layer => {
        const props = layer.feature.properties;
        const coincide = props.id_lote?.toString().toLowerCase().includes(texto);

        if (texto && coincide) {
          layer.setStyle({ weight: 3, color: "orange" });
          layer.openPopup();
        } else {
          geojsonLayer.resetStyle(layer);
        }
      });
    }
  </script>
</body>
</html>
