<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa Interactivo - AGUSIONO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body, #map {
      height: 100%; margin: 0; padding: 0;
    }
    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      z-index: 1000;
      box-shadow: 0 0 5px rgba(0,0,0,0.5);
      font-family: sans-serif;
      width: 220px;
    }
    .counter {
      margin-top: 10px;
      font-size: 14px;
    }
    .legend {
      margin-top: 10px;
      font-size: 13px;
    }
    .legend div {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }
    .legend-color {
      width: 14px;
      height: 14px;
      margin-right: 6px;
      border: 1px solid #000;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="controls">
    üîç <input type="number" id="loteInput" placeholder="Buscar ID de lote" />
    <button onclick="buscarLote()">Buscar</button>
    <div class="counter" id="contador"></div>
    <div class="legend">
      <strong>Leyenda:</strong>
      <div><div class="legend-color" style="background: green;"></div> Con agua (40m = SI)</div>
      <div><div class="legend-color" style="background: red;"></div> Sin agua (40m = NO)</div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map("map").setView([-37.403, -68.931], 16);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "¬© OpenStreetMap contributors",
      maxZoom: 20,
    }).addTo(map);

    let geojsonLayer;
    let lotesData;

    fetch("AGUSIONO.geojson")
      .then((res) => res.json())
      .then((data) => {
        lotesData = data;
        const total = data.features.length;
        const conectados = data.features.filter(f => f.properties.agua_40m === "SI").length;
        const sinAgua = total - conectados;
        const porcentaje = ((conectados / total) * 100).toFixed(1);

        document.getElementById("contador").innerHTML = `
          <b>Total lotes:</b> ${total}<br>
          <b>Con agua:</b> ${conectados} (${porcentaje}%)<br>
          <b>Sin agua:</b> ${sinAgua} (${(100 - porcentaje).toFixed(1)}%)
        `;

        geojsonLayer = L.geoJSON(data, {
          onEachFeature: function (feature, layer) {
            const p = feature.properties;
            layer.bindPopup(`
              <b>Lote:</b> ${p.fid_lote}<br>
              <b>Agua 10m:</b> ${p.agua_10m}<br>
              <b>Agua 40m:</b> ${p.agua_40m}
            `);
            layer.on("mouseover", () => {
              layer.setStyle({ weight: 3, fillOpacity: 0.7 });
            });
            layer.on("mouseout", () => {
              geojsonLayer.resetStyle(layer);
            });
          },
          style: function (feature) {
            return {
              color: feature.properties.agua_40m === "SI" ? "green" : "red",
              weight: 1,
              fillOpacity: 0.5,
            };
          }
        }).addTo(map);
      })
      .catch((err) => {
        alert("‚ùå Error cargando AGUSIONO.geojson");
        console.error(err);
      });

    function buscarLote() {
      const input = document.getElementById("loteInput").value;
      if (!input || !lotesData) return;
      const lote = lotesData.features.find(f => f.properties.fid_lote == input);
      if (lote) {
        const layer = L.geoJSON(lote, {
          style: { color: "blue", weight: 3, fillOpacity: 0.5 }
        }).addTo(map);
        map.fitBounds(layer.getBounds());
        setTimeout(() => map.removeLayer(layer), 3000);
      } else {
        alert("Lote no encontrado.");
      }
    }
  </script>
</body>
</html>
